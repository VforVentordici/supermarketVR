<html>
  <head>
    <title>A Threejs Scene</title>
    <style>
        body {
      /* set margin to 0 and overflow to hidden, to go fullscreen */
      margin: 0;
      overflow: hidden;
      background-color: #264A60;  /*BLUE 70*/
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" src="js/Three.js"></script>
    <script type="text/javascript" src="js/stats.min.js"></script>
    <script type="text/javascript" src="js/FirstPersonControls.js"></script>
    <script type="text/javascript" src="js/JSONLoader.js"></script>
    <script type="text/javascript" src="js/ParticleEngine.js"></script>
    <script type="text/javascript">

      //Global variables
      var scene,camera,renderer,controls;
      var scene_mesh;
      var light,loader;
      var clock = new THREE.Clock();
      var engine = new ParticleEngine();

      var particles, geometry, materials = [], parameters, i, h, color, size;
    
      
      function init() {

      clock = new THREE.Clock();
      // create a scene, that will hold all our elements such as objects, cameras and lights.
      scene = new THREE.Scene();


      // create a camera, which defines where we're looking at.
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

      // create a render, sets the background color and the size
      renderer = new THREE.WebGLRenderer({antialias:true,alpha: true});
      renderer.setClearColor( 0xa7fae6, 1 );
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMapEnabled = true;

      //Create a light
      light = new THREE.SpotLight(0xC0E6FF);
      light.position.set(0,20,0);
      light.shadowCameraNear = 20;
      light.shadowCameraFar = 50;
      light.castShadow = true;
      scene.add(light);

      // add fog
      scene.fog = new THREE.FogExp2( 0xFFFFFF, 0.1);
      rain =
      {
        positionStyle    : Type.CUBE,
        positionBase     : new THREE.Vector3( 0, 0, 0 ),
        positionSpread   : new THREE.Vector3( 300, 300, 300 ),

        velocityStyle    : Type.CUBE,
        velocityBase     : new THREE.Vector3( 0, -400, 0 ),
        velocitySpread   : new THREE.Vector3( 10, 50, 10 ), 
        accelerationBase : new THREE.Vector3( 0, -10,0 ),
        
        // particleTexture : THREE.ImageUtils.loadTexture( 'textures/rain.png' ),

        sizeBase    : 6.0,
        sizeSpread  : 4.0,
        colorBase   : new THREE.Vector3(1.0, 1.0, 1.0), // H,S,L
        colorSpread : new THREE.Vector3(0.00, 0.0, 0.2),
        opacityBase : 0.6,

        particlesPerSecond : 5000,
        particleDeathAge   : 1.0,   
        emitterDeathAge    : 60
      };

      engine.setValues(rain);
      engine.initialize();


      // var ambientLight = new THREE.AmbientLight( 0xffffff ); // soft white light
      // scene.add(ambientLight );

      // load models
      loader = new THREE.JSONLoader();
      loadScene();

      // position and point the camera to the center of the scene
      camera.position.x = 0;
      camera.position.y = 1;
      camera.position.z = 0;

      controls = new THREE.FirstPersonControls( camera );
      controls.movementSpeed = 1;
      controls.lookSpeed = 0.02;
      controls.lookVertical = true;  

      // // add extras
      addStats();


      // add the output of the renderer to the html element
      document.body.appendChild(renderer.domElement);

      // call the render function, after the first render, interval is determined
      // by requestAnimationFrame
      render();
    }
    
      function render() {
        var dt = clock.getDelta();
        controls.update( dt ); 
        renderer.autoClear = false;
        renderer.render(scene,camera);
        requestAnimationFrame( render ); 
        stats.update();
        engine.update( dt * 0.5 );
      }

      

      function addStats(){
        stats = new Stats();
        stats.setMode(0);
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '0px';
        stats.domElement.style.top = '0px';
        document.body.appendChild(stats.domElement);
      }

      //load the scene
      function loadScene(){
          loader.load("./models/scene.js",
          function(model,materials){
            // for(var i = 0;i<materials.length;++i)
            //   materials[i].shading = THREE.FlatShading;
            scene_mesh = new THREE.Mesh(model,new THREE.MeshFaceMaterial( materials ));
            scene_mesh.name = 'scene';
            scene_mesh.rotation.y = Math.PI;
            scene_mesh.receiveShadow = true;
            scene_mesh.castShadow = true;
            scene.add(scene_mesh);
          });
      }
            /**
       * Function handles the resize event. This make sure the camera and the renderer
       * are updated at the correct moment.
       */
      function handleResize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
      }

      window.onload = init;
      // calls the handleResize function when the window is resized
      window.addEventListener('resize', handleResize, false);

    </script>
  </body>
</html>




